"use strict";(self.webpackChunkdemo_source=self.webpackChunkdemo_source||[]).push([[305],{44305:(t,e,i)=>{i.d(e,{OpfsAhpFS:()=>T});var r=i(1951),a=i(96627);(0,a.i)(),(0,a.i)(),(0,a.i)();var s={EBADF:8,EBADFD:127,EEXIST:20,EINVAL:28,EISDIR:31,ENODEV:43,ENOENT:44,ENOTDIR:54,ENOTEMPTY:55},o=class extends Error{constructor(t,e){super(e),"number"==typeof t?this.code=t:"string"==typeof t&&(this.code=s[t])}};(0,a.i)();var l,n,h,d,c,p,f,w,m,u,y,g,S,P,k,E,O,F,N,b,D,M=16384,I=32768;l=new WeakMap,n=new WeakMap,h=new WeakMap,d=new WeakMap,c=new WeakMap,p=new WeakMap,f=new WeakMap,w=new WeakMap,m=new WeakMap,u=new WeakMap,y=new WeakMap,g=new WeakMap,S=new WeakSet,P=async function(){(0,a.f)(this,n,await navigator.storage.getDirectory()),(0,a.f)(this,h,await(0,a.g)(this,S,D).call(this,this.root,{create:!0})),(0,a.f)(this,d,await(0,a.g)(this,S,D).call(this,"data",{from:(0,a.d)(this,h),create:!0})),(0,a.f)(this,c,await(0,a.d)(this,h).getFileHandle("state.txt",{create:!0})),(0,a.f)(this,p,await(0,a.d)(this,c).createSyncAccessHandle());let t=new ArrayBuffer((0,a.d)(this,p).getSize());(0,a.d)(this,p).read(t,{at:0});let e,i=(new TextDecoder).decode(t).split("\n"),r=!1;try{e=JSON.parse(i[0])}catch{e={root:{type:"directory",lastModified:Date.now(),mode:M,children:{}},pool:[]},(0,a.d)(this,p).truncate(0),(0,a.d)(this,p).write((new TextEncoder).encode(JSON.stringify(e)),{at:0}),r=!0}this.state=e;let s=i.slice(1).filter(Boolean).map((t=>JSON.parse(t)));for(let a of s){let t=`_${a.opp}State`;if("function"==typeof this[t])try{this[t].bind(this)(...a.args)}catch(y){console.warn("Error applying OPFS AHP WAL entry",a,y)}}let o=[],m=async t=>{if("file"===t.type)try{let e=await(0,a.d)(this,d).getFileHandle(t.backingFilename),i=await e.createSyncAccessHandle();(0,a.d)(this,f).set(t.backingFilename,e),(0,a.d)(this,w).set(t.backingFilename,i)}catch(e){console.error("Error opening file handle for node",t,e)}else for(let i of Object.values(t.children))o.push(m(i))};await m(this.state.root);let u=[];for(let l of this.state.pool)u.push(new Promise((async t=>{(0,a.d)(this,f).has(l)&&console.warn("File handle already exists for pool file",l);let e=await(0,a.d)(this,d).getFileHandle(l),i=await e.createSyncAccessHandle();(0,a.d)(this,f).set(l,e),(0,a.d)(this,w).set(l,i),t()})));await Promise.all([...o,...u]),await this.maintainPool(r?this.initialPoolSize:this.maintainedPoolSize),(0,a.f)(this,l,!0)},k=function(t,e){let i=(0,a.g)(this,S,E).call(this,t);try{e()}catch(r){throw(0,a.d)(this,p).truncate(i),r}},E=function(t){let e=JSON.stringify(t),i=(new TextEncoder).encode(`\n${e}`),r=(0,a.d)(this,p).getSize();return(0,a.d)(this,p).write(i,{at:r}),(0,a.d)(this,g).add((0,a.d)(this,p)),r},O=function(t){return t.split("/").filter(Boolean)},F=function(t,e){let i=(0,a.g)(this,S,O).call(this,t),r=e||this.state.root;for(let a of i){if("directory"!==r.type)throw new o("ENOTDIR","Not a directory");if(!Object.prototype.hasOwnProperty.call(r.children,a))throw new o("ENOENT","No such file or directory");r=r.children[a]}return r},N=function(t){let e=(0,a.d)(this,u).get(t);if(!e)throw new o("EBADF","Bad file descriptor");return e},b=function(){let t=++(0,a.h)(this,m)._;for(;(0,a.d)(this,u).has(t);)(0,a.h)(this,m)._++;return t},D=async function(t,e){let i=(0,a.g)(this,S,O).call(this,t),r=e?.from||(0,a.d)(this,n);for(let a of i)r=await r.getDirectoryHandle(a,{create:e?.create});return r};var _,v,A=class t{constructor(t){let{root:e,initialPoolSize:i,maintainedPoolSize:r}=t;(0,a.e)(this,S),(0,a.e)(this,l,!1),(0,a.e)(this,n),(0,a.e)(this,h),(0,a.e)(this,d),(0,a.e)(this,c),(0,a.e)(this,p),(0,a.e)(this,f,new Map),(0,a.e)(this,w,new Map),(0,a.e)(this,m,0),(0,a.e)(this,u,new Map),(0,a.e)(this,y,new Map),this.lastCheckpoint=0,this.checkpointInterval=6e4,this.poolCounter=0,(0,a.e)(this,g,new Set),this.root=e,this.initialPoolSize=i||1e3,this.maintainedPoolSize=r||100,this.readyPromise=(0,a.g)(this,S,P).call(this)}static async create(e){let i=new t(e);return await i.readyPromise,i}get ready(){return(0,a.d)(this,l)}async maintainPool(t){let e=(t=t||this.maintainedPoolSize)-this.state.pool.length,i=[];for(let r=0;r<e;r++)i.push(new Promise((async t=>{++this.poolCounter;let e=`${(Date.now()-1704063600).toString(16).padStart(8,"0")}-${this.poolCounter.toString(16).padStart(8,"0")}`,i=await(0,a.d)(this,d).getFileHandle(e,{create:!0}),r=await i.createSyncAccessHandle();(0,a.d)(this,f).set(e,i),(0,a.d)(this,w).set(e,r),(0,a.g)(this,S,E).call(this,{opp:"createPoolFile",args:[e]}),this.state.pool.push(e),t()})));for(let r=0;r>e;r--)i.push(new Promise((async t=>{let e=this.state.pool.pop();(0,a.g)(this,S,E).call(this,{opp:"deletePoolFile",args:[e]});let i=(0,a.d)(this,f).get(e);(0,a.d)(this,w).get(e)?.close(),await i.remove().then((()=>{(0,a.d)(this,f).delete(e),(0,a.d)(this,w).delete(e),t()}))})));await Promise.all(i)}_createPoolFileState(t){this.state.pool.push(t)}_deletePoolFileState(t){let e=this.state.pool.indexOf(t);e>-1&&this.state.pool.splice(e,1)}async maybeCheckpointState(){Date.now()-this.lastCheckpoint>this.checkpointInterval&&await this.checkpointState()}async checkpointState(){let t=(new TextEncoder).encode(JSON.stringify(this.state));(0,a.d)(this,p).truncate(0),(0,a.d)(this,p).write(t,{at:0}),(0,a.d)(this,p).flush(),this.lastCheckpoint=Date.now()}flush(){for(let t of(0,a.d)(this,g))try{t.flush()}catch{}(0,a.d)(this,g).clear()}exit(){for(let t of(0,a.d)(this,w).values())t.close();(0,a.d)(this,p).flush(),(0,a.d)(this,p).close()}chmod(t,e){(0,a.g)(this,S,k).call(this,{opp:"chmod",args:[t,e]},(()=>{this._chmodState(t,e)}))}_chmodState(t,e){(0,a.g)(this,S,F).call(this,t).mode=e}close(t){let e=(0,a.g)(this,S,N).call(this,t);(0,a.d)(this,u).delete(t),(0,a.d)(this,y).delete(e)}fstat(t){let e=(0,a.g)(this,S,N).call(this,t);return this.lstat(e)}lstat(t){let e=(0,a.g)(this,S,F).call(this,t),i="file"===e.type?(0,a.d)(this,w).get(e.backingFilename).getSize():0;return{dev:0,ino:0,mode:e.mode,nlink:1,uid:0,gid:0,rdev:0,size:i,blksize:4096,blocks:Math.ceil(i/4096),atime:e.lastModified,mtime:e.lastModified,ctime:e.lastModified}}mkdir(t,e){(0,a.g)(this,S,k).call(this,{opp:"mkdir",args:[t,e]},(()=>{this._mkdirState(t,e)}))}_mkdirState(t,e){let i=(0,a.g)(this,S,O).call(this,t),r=i.pop(),s=[],l=this.state.root;for(let a of i){if(s.push(t),!Object.prototype.hasOwnProperty.call(l.children,a)){if(!e?.recursive)throw new o("ENOENT","No such file or directory");this.mkdir(s.join("/"))}if("directory"!==l.children[a].type)throw new o("ENOTDIR","Not a directory");l=l.children[a]}if(Object.prototype.hasOwnProperty.call(l.children,r))throw new o("EEXIST","File exists");let n={type:"directory",lastModified:Date.now(),mode:e?.mode||M,children:{}};l.children[r]=n}open(t,e,i){if("file"!==(0,a.g)(this,S,F).call(this,t).type)throw new o("EISDIR","Is a directory");let r=(0,a.g)(this,S,b).call(this);return(0,a.d)(this,u).set(r,t),(0,a.d)(this,y).set(t,r),r}readdir(t){let e=(0,a.g)(this,S,F).call(this,t);if("directory"!==e.type)throw new o("ENOTDIR","Not a directory");return Object.keys(e.children)}read(t,e,i,r,s){let l=(0,a.g)(this,S,N).call(this,t),n=(0,a.g)(this,S,F).call(this,l);if("file"!==n.type)throw new o("EISDIR","Is a directory");return(0,a.d)(this,w).get(n.backingFilename).read(new Int8Array(e.buffer,i,r),{at:s})}rename(t,e){(0,a.g)(this,S,k).call(this,{opp:"rename",args:[t,e]},(()=>{this._renameState(t,e,!0)}))}_renameState(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=(0,a.g)(this,S,O).call(this,t),s=r.pop(),l=(0,a.g)(this,S,F).call(this,r.join("/"));if(!Object.prototype.hasOwnProperty.call(l.children,s))throw new o("ENOENT","No such file or directory");let n=(0,a.g)(this,S,O).call(this,e),h=n.pop(),d=(0,a.g)(this,S,F).call(this,n.join("/"));if(i&&Object.prototype.hasOwnProperty.call(d.children,h)){let t=d.children[h];(0,a.d)(this,w).get(t.backingFilename).truncate(0),this.state.pool.push(t.backingFilename)}d.children[h]=l.children[s],delete l.children[s]}rmdir(t){(0,a.g)(this,S,k).call(this,{opp:"rmdir",args:[t]},(()=>{this._rmdirState(t)}))}_rmdirState(t){let e=(0,a.g)(this,S,O).call(this,t),i=e.pop(),r=(0,a.g)(this,S,F).call(this,e.join("/"));if(!Object.prototype.hasOwnProperty.call(r.children,i))throw new o("ENOENT","No such file or directory");let s=r.children[i];if("directory"!==s.type)throw new o("ENOTDIR","Not a directory");if(Object.keys(s.children).length>0)throw new o("ENOTEMPTY","Directory not empty");delete r.children[i]}truncate(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=(0,a.g)(this,S,F).call(this,t);if("file"!==i.type)throw new o("EISDIR","Is a directory");let r=(0,a.d)(this,w).get(i.backingFilename);if(!r)throw new o("ENOENT","No such file or directory");r.truncate(e),(0,a.d)(this,g).add(r)}unlink(t){(0,a.g)(this,S,k).call(this,{opp:"unlink",args:[t]},(()=>{this._unlinkState(t,!0)}))}_unlinkState(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=(0,a.g)(this,S,O).call(this,t),r=i.pop(),s=(0,a.g)(this,S,F).call(this,i.join("/"));if(!Object.prototype.hasOwnProperty.call(s.children,r))throw new o("ENOENT","No such file or directory");let l=s.children[r];if("file"!==l.type)throw new o("EISDIR","Is a directory");if(delete s.children[r],e){let e=(0,a.d)(this,w).get(l.backingFilename);e?.truncate(0),(0,a.d)(this,g).add(e),(0,a.d)(this,y).has(t)&&((0,a.d)(this,u).delete((0,a.d)(this,y).get(t)),(0,a.d)(this,y).delete(t))}this.state.pool.push(l.backingFilename)}utimes(t,e,i){(0,a.g)(this,S,k).call(this,{opp:"utimes",args:[t,e,i]},(()=>{this._utimesState(t,e,i)}))}_utimesState(t,e,i){(0,a.g)(this,S,F).call(this,t).lastModified=i}writeFile(t,e,i){let r=(0,a.g)(this,S,O).call(this,t),s=r.pop(),o=(0,a.g)(this,S,F).call(this,r.join("/"));if(Object.prototype.hasOwnProperty.call(o.children,s)){let e=o.children[s];e.lastModified=Date.now(),(0,a.g)(this,S,E).call(this,{opp:"setLastModified",args:[t,e.lastModified]})}else{if(0===this.state.pool.length)throw new Error("No more file handles available in the pool");let e={type:"file",lastModified:Date.now(),mode:i?.mode||I,backingFilename:this.state.pool.pop()};o.children[s]=e,(0,a.g)(this,S,E).call(this,{opp:"createFileNode",args:[t,e]})}let l=o.children[s],n=(0,a.d)(this,w).get(l.backingFilename);e.length>0&&(n.write("string"==typeof e?(new TextEncoder).encode(e):new Int8Array(e),{at:0}),t.startsWith("/pg_wal")&&(0,a.d)(this,g).add(n))}_createFileNodeState(t,e){let i=(0,a.g)(this,S,O).call(this,t),r=i.pop();(0,a.g)(this,S,F).call(this,i.join("/")).children[r]=e;let s=this.state.pool.indexOf(e.backingFilename);return s>-1&&this.state.pool.splice(s,1),e}_setLastModifiedState(t,e){(0,a.g)(this,S,F).call(this,t).lastModified=e}write(t,e,i,r,s){let l=(0,a.g)(this,S,N).call(this,t),n=(0,a.g)(this,S,F).call(this,l);if("file"!==n.type)throw new o("EISDIR","Is a directory");let h=(0,a.d)(this,w).get(n.backingFilename);if(!h)throw new o("EBADF","Bad file descriptor");let d=h.write(new Int8Array(e,i,r),{at:s});return l.startsWith("/pg_wal")&&(0,a.d)(this,g).add(h),d}},T=class extends r.a{constructor(t){let{initialPoolSize:e,maintainedPoolSize:i}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(t),(0,a.e)(this,_),(0,a.e)(this,v),(0,a.f)(this,_,e??1e3),(0,a.f)(this,v,i??100)}async emscriptenOpts(t){return this.opfsAhp=await A.create({root:this.dataDir,initialPoolSize:(0,a.d)(this,_),maintainedPoolSize:(0,a.d)(this,v)}),{...t,preRun:[...t.preRun||[],t=>{let e=((t,i)=>{let r=t.FS,a={tryFSOperation(t){try{return t()}catch(e){throw e.code?"UNKNOWN"===e.code?new r.ErrnoError(s.EINVAL):new r.ErrnoError(e.code):e}},mount:t=>a.createNode(null,"/",16895,0),syncfs(t,e,i){},createNode(t,e,i,s){if(!r.isDir(i)&&!r.isFile(i))throw new r.ErrnoError(28);let o=r.createNode(t,e,i);return o.node_ops=a.node_ops,o.stream_ops=a.stream_ops,o},getMode:function(t){return a.tryFSOperation((()=>i.lstat(t).mode))},realPath:function(t){let e=[];for(;t.parent!==t;)e.push(t.name),t=t.parent;return e.push(t.mount.opts.root),e.reverse(),e.join("/")},node_ops:{getattr(t){a.realPath(t);let e=a.realPath(t);return a.tryFSOperation((()=>{let r=i.lstat(e);return{...r,dev:0,ino:t.id,nlink:1,rdev:t.rdev,atime:new Date(r.atime),mtime:new Date(r.mtime),ctime:new Date(r.ctime)}}))},setattr(t,e){a.realPath(t);let r=a.realPath(t);a.tryFSOperation((()=>{void 0!==e.mode&&i.chmod(r,e.mode),void 0!==e.size&&i.truncate(r,e.size),void 0!==e.timestamp&&i.utimes(r,e.timestamp,e.timestamp),void 0!==e.size&&i.truncate(r,e.size)}))},lookup(t,e){a.realPath(t);let i=[a.realPath(t),e].join("/"),r=a.getMode(i);return a.createNode(t,e,r)},mknod(t,e,s,o){a.realPath(t);let l=a.createNode(t,e,s,o),n=a.realPath(l);return a.tryFSOperation((()=>(r.isDir(l.mode)?i.mkdir(n,{mode:s}):i.writeFile(n,"",{mode:s}),l)))},rename(t,e,r){a.realPath(t),a.realPath(e);let s=a.realPath(t),o=[a.realPath(e),r].join("/");a.tryFSOperation((()=>{i.rename(s,o)})),t.name=r},unlink(t,e){a.realPath(t);let r=[a.realPath(t),e].join("/");try{i.unlink(r)}catch{}},rmdir(t,e){a.realPath(t);let r=[a.realPath(t),e].join("/");return a.tryFSOperation((()=>{i.rmdir(r)}))},readdir(t){a.realPath(t);let e=a.realPath(t);return a.tryFSOperation((()=>i.readdir(e)))},symlink(t,e,i){throw a.realPath(t),new r.ErrnoError(63)},readlink(t){throw a.realPath(t),new r.ErrnoError(63)}},stream_ops:{open(t){a.realPath(t.node);let e=a.realPath(t.node);return a.tryFSOperation((()=>{r.isFile(t.node.mode)&&(t.shared.refcount=1,t.nfd=i.open(e))}))},close:t=>(a.realPath(t.node),a.tryFSOperation((()=>{r.isFile(t.node.mode)&&t.nfd&&0===--t.shared.refcount&&i.close(t.nfd)}))),dup(t){a.realPath(t.node),t.shared.refcount++},read:(t,e,r,s,o)=>(a.realPath(t.node),0===s?0:a.tryFSOperation((()=>i.read(t.nfd,e,r,s,o)))),write:(t,e,r,s,o)=>(a.realPath(t.node),a.tryFSOperation((()=>i.write(t.nfd,e.buffer,r,s,o)))),llseek(t,e,s){a.realPath(t.node);let o=e;if(1===s?o+=t.position:2===s&&r.isFile(t.node.mode)&&a.tryFSOperation((()=>{let e=i.fstat(t.nfd);o+=e.size})),o<0)throw new r.ErrnoError(28);return o},mmap(e,i,o,l,n){if(a.realPath(e.node),!r.isFile(e.node.mode))throw new r.ErrnoError(s.ENODEV);let h=t.mmapAlloc(i);return a.stream_ops.read(e,t.HEAP8,h,i,o),{ptr:h,allocated:!0}},msync:(t,e,i,r,s)=>(a.realPath(t.node),a.stream_ops.write(t,e,0,r,i),0)}};return a})(t,this.opfsAhp);t.FS.mkdir(r.h),t.FS.mount(e,{},r.h)}]}}async syncToFs(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];await(this.opfsAhp?.maybeCheckpointState()),await(this.opfsAhp?.maintainPool()),e||this.opfsAhp?.flush()}async dumpTar(t,e,i){return(0,r.c)(t,e,i)}async close(t){this.opfsAhp?.exit(),t.quit()}};_=new WeakMap,v=new WeakMap}}]);
//# sourceMappingURL=305.de336abc.chunk.js.map